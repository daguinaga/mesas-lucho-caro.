<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucho & Caro ‚Äî Busca tu mesa</title>
<meta name="description" content="Encuentra tu mesa al toque para la boda de Lucho & Caro" />
<style>
  :root{--ink:#0f172a;--muted:#475569;--card:#fff;--bg1:#f0f9ff;--bg2:#ecfdf5;--bg3:#fffbeb;--br:#e2e8f0;--radius:14px}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);
       background:linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3));}
  header{text-align:center;padding:42px 16px 18px}
  h1{margin:0;font-size:clamp(28px,4vw,40px)}
  .sub{color:var(--muted);margin-top:6px}
  .tag{display:inline-block;margin-top:10px}
  .wrap{max-width:860px;margin:0 auto;padding:0 16px 36px}
  .tabs{display:flex;gap:8px;justify-content:center;margin:18px 0 22px;flex-wrap:wrap}
  .btn{border:1px solid var(--br);background:#fff;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:#0284c7;color:#fff;border:none}
  .card{background:var(--card);border:1px solid var(--br);border-radius:var(--radius);box-shadow:0 8px 28px rgba(2,8,23,.06)}
  .card-body{padding:16px}
  .row{display:flex;gap:10px}
  .input{flex:1;height:44px;border:1px solid #cbd5e1;border-radius:12px;padding:0 12px;font-size:16px;outline:none}
  .input:focus{border-color:#0ea5e9;box-shadow:0 0 0 3px rgba(14,165,233,.18)}
  .ghost{border:none;background:transparent;font-weight:600;color:#334155;cursor:pointer}
  .results{margin-top:12px;display:grid;gap:10px}
  .result{display:flex;justify-content:space-between;align-items:flex-start;border:1px solid var(--br);background:#fff;border-radius:12px;padding:12px 14px}
  .grid{display:grid;gap:14px}
  @media(min-width:640px){.grid{grid-template-columns:1fr 1fr}}
  h3{margin:0;font-size:18px}
  ul{margin:10px 0 0;padding:0;list-style:none;display:grid;gap:6px}
  .hint{color:#64748b;font-size:12px;margin-top:8px}
  footer{text-align:center;color:#64748b;font-size:12px;padding:24px 16px 36px}
</style>
</head>
<body>
<header>
  <h1>Lucho &amp; Caro üíõ</h1>
  <!-- Fecha y lugar en dos l√≠neas -->
  <div class="sub">
    <div>üìÖ 18 de octubre de 2025</div>
    <div>üìç Casino de Pimentel, Per√∫</div>
  </div>
  <div class="tag"><strong>Tu mesa es‚Ä¶</strong> encu√©ntrala al toque ‚ú®</div>
  <div class="tabs">
    <button id="tab-search" class="btn primary">üîé Buscar por nombre</button>
    <button id="tab-list" class="btn">üìã Ver lista por mesas</button>
  </div>
</header>

<main class="wrap">
  <!-- SEARCH -->
  <section id="search-section">
    <div class="card"><div class="card-body">
      <div class="row">
        <input id="search" class="input" placeholder="Escribe tu nombre y apellidos‚Ä¶" />
        <button id="clear" class="ghost">Limpiar</button>
      </div>
      <div id="results" class="results"></div>
      <p id="tip" class="hint" style="display:none">Sugerencia: escribe al menos 3 letras para mejores resultados.</p>
    </div></div>
  </section>

  <!-- LIST -->
  <section id="list-section" style="display:none">
    <div id="tables" class="grid"></div>
  </section>
</main>

<footer>
  ¬øNo encuentras tu nombre? Con gusto te ayudamos. ‚ò∫Ô∏è
</footer>

<script>
  // ---------- Utils ----------
  const norm = s => (s || "")
    .normalize("NFD").replace(/\p{Diacritic}/gu, "")
    .toLowerCase().trim();
  const $ = id => document.getElementById(id);

  // ---------- State ----------
  let guests = []; // [{name, table}]

  // ---------- CSV helpers (comma OR tab) ----------
  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if (lines.length <= 1) return [];
    const hdr = lines[0].split(/,|\t/).map(h => norm(h));
    const ni = hdr.findIndex(h => h.includes("nombre") || h.includes("guest") || h.includes("invitado"));
    const ti = hdr.findIndex(h => h.includes("mesa") || h.includes("table"));
    if (ni === -1 || ti === -1) return [];

    const out = [];
    for (let i = 1; i < lines.length; i++){
      const cols = lines[i].split(/,|\t/);
      const name = (cols[ni] || "").trim();
      const table = (cols[ti] || "").trim();
      if (!name) continue;
      out.push({ name, table });
    }
    return out;
  }

  // Extract just the mesa number (as string). Returns "" if none.
  function tableNumber(raw){
    const m = String(raw || "").match(/\d+/);
    return m ? m[0] : "";
  }

  // Card label for tables
  function tableLabelFrom(raw){
    const n = tableNumber(raw);
    return n ? `Mesa ${n}` : ""; // empty means "skip this table"
  }

  // Numeric sort of mesa ("" goes last / skipped anyway)
  function tableSortKey(raw){
    const n = tableNumber(raw);
    return n ? parseInt(n, 10) : Number.POSITIVE_INFINITY;
  }

  // ---------- Search ----------
  const search = $("search"), results = $("results"), tip = $("tip");
  function renderResults(){
    const q = norm(search.value);
    results.innerHTML = "";
    tip.style.display = (!q || q.length >= 3) ? "none" : "";
    if (!q) return;

    // exclude guests without mesa number
    const found = guests
      .filter(g => tableNumber(g.table))           // only assigned
      .filter(g => norm(g.name).includes(q))
      .sort((a,b)=> a.name.localeCompare(b.name, "es"));

    if (!found.length){
      results.innerHTML = '<p class="hint" style="font-size:14px">No encontramos ese nombre. Revisa ortograf√≠a o ac√©rcate al personal üí¨</p>';
      return;
    }

    found.slice(0,50).forEach(g => {
      const num = tableNumber(g.table);
      const row = document.createElement("div");
      row.className = "result";
      row.innerHTML = `
        <div>
          <strong>${g.name}</strong><br>
          Tu mesa: <b>${num || "por asignar"}</b>
        </div>`;
      results.appendChild(row);
    });

    if (found.length > 50){
      const p = document.createElement("p");
      p.className = "hint"; p.textContent = "Mostrando 50 resultados. Afina tu b√∫squeda para ver menos.";
      results.appendChild(p);
    }
  }
  search.addEventListener("input", renderResults);
  $("clear").addEventListener("click", ()=>{ search.value=""; results.innerHTML=""; search.focus(); });

  // ---------- List by table ----------
  const tablesDiv = $("tables");
  function renderTables(){
    tablesDiv.innerHTML = "";

    // group by mesa number; skip blanks entirely
    const map = {};
    for (const g of guests) {
      const num = tableNumber(g.table);
      if (!num) continue;               // skip unassigned
      (map[num] ||= []).push(g);
    }

    Object.keys(map)
      .sort((a,b)=> parseInt(a,10) - parseInt(b,10)) // numeric order
      .forEach(num=>{
        const card = document.createElement("div");
        card.className = "card";
        const body = document.createElement("div");
        body.className = "card-body";
        body.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <h3>Mesa ${num}</h3>
          </div>
          <ul>${
            map[num]
              .sort((a,b)=> a.name.localeCompare(b.name, "es"))
              .map(p=> `<li>${p.name}</li>`).join("")
          }</ul>`;
        card.appendChild(body);
        tablesDiv.appendChild(card);
      });
  }
  window.renderTables = renderTables;

  // ---------- Tabs ----------
  const tabSearch = $("tab-search"), tabList = $("tab-list");
  const secSearch = $("search-section"), secList = $("list-section");
  tabSearch.addEventListener("click", ()=>{
    tabSearch.classList.add("primary"); tabList.classList.remove("primary");
    secSearch.style.display=""; secList.style.display="none"; search.focus();
  });
  tabList.addEventListener("click", ()=>{
    tabList.classList.add("primary"); tabSearch.classList.remove("primary");
    secSearch.style.display="none"; secList.style.display="";
    renderTables();
  });

  // ---------- Robust CSV Loader (auto path + no-cache) ----------
  function buildPaths(){
    const folder = location.pathname.replace(/[^/]+$/, "");
    const paths = [ `${folder}mesas.csv`, "mesas.csv" ];
    // raw.githubusercontent fallback if on GitHub Pages
    const hostParts = location.hostname.split(".");
    const pathParts = location.pathname.split("/").filter(Boolean);
    if (hostParts[1] === "github" && hostParts[2] === "io" && pathParts.length >= 1) {
      const owner = hostParts[0], repo = pathParts[0];
      paths.push(`https://raw.githubusercontent.com/${owner}/${repo}/main/mesas.csv`);
    }
    return paths;
  }

  async function loadCSV() {
    for (const url of buildPaths()) {
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) continue;
        const txt = await res.text();
        let parsed = parseCSV(txt);
        // remove anyone without mesa number
        parsed = parsed.filter(g => tableNumber(g.table));
        if (parsed.length) {
          guests = parsed;
          if (secList.style.display === "none") {
            search.dispatchEvent(new Event("input"));
          } else {
            renderTables();
          }
          return;
        }
      } catch(e) {}
    }
    // If nothing loaded, render empty states
    renderResults(); renderTables();
    console.warn("No se pudo cargar mesas.csv desde ninguna ruta.");
  }
  loadCSV();
</script>
</body>
</html>
